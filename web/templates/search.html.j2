<!doctype html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>情报检索</title>
  <style>
    body {font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans"; padding: 24px; max-width: 1000px; margin: auto;}
    input, select {padding:8px 10px; margin-right:8px; border:1px solid #e5e7eb; border-radius:10px;}
    .card {border:1px solid #e5e7eb; border-radius:14px; padding:16px; margin:12px 0;}
    a {color:#0366d6; text-decoration:none;}
  </style>
</head>
<body>
  <h1>编译器情报检索</h1>
  <div>
    <input id="q" placeholder="关键词…" />
    <select id="proj">
      <option value="">全部项目</option>
      <option>LLVM</option><option>GCC</option><option>Rust</option><option>Swift</option>
      <option>Linux Kernel</option><option>V8</option><option>GraalVM</option><option>Cranelift/Wasmtime</option>
    </select>
    <select id="pri">
      <option value="">全部优先级</option>
      <option>high</option><option>medium</option><option>low</option>
    </select>
    <button onclick="doSearch()">搜索</button>
  </div>
  <div id="out"></div>

<script>
const HOST = "{{ meili_host or 'http://localhost:7700' }}";
const INDEX = "intel_clusters";
const KEY = "{{ meili_key or '' }}"; // 把 pipelines/index_search.py 打印出的 key 填进来，或 publish 时注入

async function doSearch() {
  const q = document.getElementById('q').value || "";
  const proj = document.getElementById('proj').value;
  const pri  = document.getElementById('pri').value;
  const filter = [];
  if (proj) filter.push(`projects = "${proj}"`);
  if (pri)  filter.push(`priority = "${pri}"`);

  const res = await fetch(`${HOST}/indexes/${INDEX}/search`, {
    method:'POST',
    headers: {'Content-Type':'application/json', ...(KEY? {'Authorization':`Bearer ${KEY}`} : {})},
    body: JSON.stringify({ q, limit: 30, filter: filter.length? filter.join(' AND ') : undefined, sort:['date:desc'] })
  });
  const data = await res.json();
  const out = document.getElementById('out'); out.innerHTML = '';
  (data.hits || []).forEach(h => {
    const div = document.createElement('div'); div.className='card';
    const link = (h.links && h.links.length)? h.links[0] : '#';
    div.innerHTML = `<h3>${h.title || '(no title)'}</h3>
      <p>${(h.text||'').slice(0,220)}</p>
      <div style="font-size:13px;margin:8px 0;color:#475569">[${(h.projects||[]).join(', ') }] · ${h.priority || 'low'} · ${h.date || ''}</div>
      <a target="_blank" href="${link}">${link}</a>`;
    out.appendChild(div);
  });
}
</script>
</body>
</html>