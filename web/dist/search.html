<!-- web/templates/search.html.j2 -->
<!doctype html>
<html lang="zh-cn" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>情报检索</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
</head>
<body class="bg-base-100">
  <div class="max-w-6xl mx-auto p-4 md:p-6">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">情报检索（默认仅最近一周）</h1>
      <div class="join">
        <button class="btn btn-sm join-item" id="btn-zh">中文</button>
        <button class="btn btn-sm join-item btn-ghost" id="btn-en">English</button>
      </div>
    </div>

    <div class="mt-3 grid md:grid-cols-12 gap-2">
      <input id="q" class="input input-bordered md:col-span-6" placeholder="关键词（如：RISC-V、regression、TableGen）"/>
      <select id="proj" class="select select-bordered md:col-span-2">
        <option value="">全部项目</option>
        <option>LLVM</option><option>GCC</option><option>Rust</option><option>Swift</option><option>V8</option><option>GraalVM</option><option>Cranelift/Wasmtime</option><option>Zig</option>
      </select>
      <select id="pri" class="select select-bordered md:col-span-2">
        <option value="">全部优先级</option>
        <option>high</option><option>medium</option><option>low</option>
      </select>
      <select id="arch" class="select select-bordered md:col-span-2">
        <option value="">全部架构</option>
        <option>RISC-V</option><option>ARM64</option><option>x86_64</option><option>WASM</option><option>GPU</option>
      </select>
    </div>

    <div class="mt-2 flex gap-2">
      <button class="btn btn-primary btn-sm" onclick="doSearch()">搜索</button>
      <button class="btn btn-ghost btn-sm" onclick="resetFilters()">重置</button>
    </div>

    <div id="out" class="mt-4 grid md:grid-cols-2 gap-3"></div>
  </div>

<script>
const HOST = "http://localhost:7700";
const INDEX = "intel_clusters";
const KEY = "";
let lang = 'zh';

function setLang(l){ lang=l;
  document.getElementById('btn-zh').classList.toggle('btn-ghost', l!=='zh');
  document.getElementById('btn-en').classList.toggle('btn-ghost', l!=='en');
  doSearch();
}
document.getElementById('btn-zh').onclick=()=>setLang('zh');
document.getElementById('btn-en').onclick=()=>setLang('en');

function resetFilters(){
  document.getElementById('q').value='';
  document.getElementById('proj').value='';
  document.getElementById('pri').value='';
  document.getElementById('arch').value='';
}

async function doSearch(){
  const q = document.getElementById('q').value || "";
  const proj = document.getElementById('proj').value;
  const pri  = document.getElementById('pri').value;
  const arch = document.getElementById('arch').value;

  const since = new Date(Date.now() - 7*24*60*60*1000).toISOString();
  const filters = [`date >= ${JSON.stringify(since)}`];
  if (proj) filters.push(`projects = "${proj}"`);
  if (pri)  filters.push(`priority = "${pri}"`);
  if (arch) filters.push(`arches = "${arch}"`);

  // 搜索字段包含中英文摘要与标题
  const res = await fetch(`${HOST}/indexes/${INDEX}/search`, {
    method:'POST',
    headers: {'Content-Type':'application/json', ...(KEY? {'Authorization':`Bearer ${KEY}`} : {})},
    body: JSON.stringify({
      q, limit: 40, filter: filters.join(' AND '),
      sort:['date:desc'],
      attributesToSearchOn: ['title','title_zh','text','context_zh','key_points','key_points_zh','tags']
    })
  });
  const data = await res.json();
  const out = document.getElementById('out'); out.innerHTML='';
  (data.hits||[]).forEach(h=>{
    const title = (lang==='zh' ? (h.title_zh||h.title) : (h.title||h.title_zh)) || '(no title)';
    const ctx = (lang==='zh' ? (h.context_zh||h.text) : (h.text||h.context_zh)) || '';
    const link = (h.links && h.links[0]) || '#';
    const badge = (h.priority||'low');
    const tags = (h.tags||[]).map(t=>`<div class="badge badge-outline">${t}</div>`).join('');
    const html = `
      <div class="card bg-base-100 border border-base-200">
        <div class="card-body">
          <div class="flex items-center gap-2">
            <h3 class="card-title">${title}</h3>
            <div class="badge ${badge==='high'?'badge-error':(badge==='medium'?'badge-warning':'badge-success')}">${badge}</div>
            <div class="text-xs text-base-content/60">${h.date||''}</div>
          </div>
          <p class="text-base-content/70">${(ctx||'').slice(0,240)}</p>
          <a class="btn btn-sm mt-1" target="_blank" href="${link}">查看原文</a>
          <div class="mt-2 flex flex-wrap gap-1">${tags}</div>
        </div>
      </div>`;
    out.insertAdjacentHTML('beforeend', html);
  });
}
setLang('zh'); // 初次加载即查询
</script>
</body>
</html>